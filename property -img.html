<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>房源图片批量生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
        }
        .file-drop-zone {
            transition: all 0.2s ease-in-out;
        }
        .file-drop-zone.drag-over {
            background-color: #e0f2fe;
            border-color: #0284c7;
        }
        /* 统一主按钮配色（与站内CTA一致） */
        .primary-btn {
            background-color: #0057ff;
        }
        .primary-btn:hover {
            background-color: #0047e5;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="font-bold" style="font-size:32px; line-height:1.3; color:#2d2d2d; font-family:'Inter','PingFang SC',sans-serif;">房源图片批量生成器</h1>
            <p class="mt-2" style="font-size:14px; line-height:1.6; color:#595959; font-family:'Inter','PingFang SC',sans-serif;">上传您的 CSV 文件，即可根据模板批量生成房源宣传图。</p>
        </header>

        <main>
            <!-- File Upload Section -->
            <div id="upload-section" class="mb-8">
                <label for="csv-file-input" id="file-drop-zone" class="flex justify-center w-full h-48 px-4 transition bg-white border-2 border-slate-300 border-dashed rounded-md appearance-none cursor-pointer hover:border-sky-600 focus:outline-none">
                    <span class="flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <span class="font-medium text-slate-500">
                            将 CSV 文件拖拽到此处，或
                            <span class="text-sky-600 underline">点击选择文件</span>
                        </span>
                    </span>
                    <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                </label>
                 <div id="file-name-display" class="text-center text-slate-500 mt-2"></div>
            </div>

            <!-- Controls and Status Section -->
            <div id="controls-section" class="hidden text-center mb-8 bg-white p-4 rounded-lg shadow-md">
                 <div id="status-container" class="flex items-center justify-center space-x-3 mb-4">
                     <div id="spinner" class="animate-spin rounded-full h-6 w-6 border-b-2 border-sky-600"></div>
                     <p id="status-text" class="text-lg text-slate-700">正在处理中，请稍候...</p>
                 </div>
                 <button id="download-all-btn" class="hidden primary-btn text-white font-bold py-2 px-6 rounded-lg transition duration-300 disabled:bg-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    全部下载为 ZIP
                 </button>
            </div>


            <!-- Results Section -->
            <div id="results-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Generated images will be appended here -->
            </div>
        </main>
    </div>

    <script>
        const fileInput = document.getElementById('csv-file-input');
        const dropZone = document.getElementById('file-drop-zone');
        const fileNameDisplay = document.getElementById('file-name-display');
        const resultsGrid = document.getElementById('results-grid');
        const controlsSection = document.getElementById('controls-section');
        const statusText = document.getElementById('status-text');
        const spinner = document.getElementById('spinner');
        const downloadAllBtn = document.getElementById('download-all-btn');

        // === 统一视觉常量（独立页面对齐站内 PropertyCard）===
        const TOKENS = {
            PRIMARY: '#2d2d2d',     // 主文案
            SECONDARY: '#595959',   // 次文案
            LINK: '#0057ff',        // 链接/强调
            BORDER: '#e3e3e3',
            BG_CARD: '#ffffff'
        };
        const FAMILY = "'Inter', 'PingFang SC', sans-serif";
        const TYPE = {
            price: '700 22px',
            unit: '400 14px',
            address: '500 15px',
            spec: '600 14px',
            date: '400 13px',
            inspect: '500 12px'
        };
        const SPACE = { xs: 4, sm: 8, md: 12, lg: 16 };
        const SIZE = { price: 22, unit: 14, address: 15, specRow: 24, date: 13, inspect: 12 };
        const ICON = { size: 24, stroke: 2.2 };
        const LAYOUT = {
            mainHeight: 810,
            textStartY: 840,
            subX1: 20, subX2: 370, subX3: 720,
            subW: 340, subH: 255, subY: 1165
        };

        // --- Drag and Drop Logic ---
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length) {
                fileInput.files = files;
                handleFileSelect({ target: fileInput });
            }
        });
        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            
            fileNameDisplay.textContent = `已选择文件: ${file.name}`;
            resultsGrid.innerHTML = '';
            controlsSection.style.display = 'block';
            downloadAllBtn.style.display = 'none';
            spinner.style.display = 'block';
            statusText.textContent = `正在读取和解析 ${file.name}...`;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    processData(results.data);
                },
                error: (error) => {
                    console.error('CSV 解析错误:', error);
                    statusText.textContent = `解析CSV文件失败: ${error.message}`;
                    spinner.style.display = 'none';
                }
            });
        }
        
        // --- Image Generation Logic ---
        async function processData(data) {
            statusText.textContent = `共找到 ${data.length} 条房源数据，开始生成图片...`;
            const imagePromises = data.map((row, index) => generateImageCard(row, index + 1));
            
            await Promise.all(imagePromises);

            spinner.style.display = 'none';
            statusText.textContent = `全部 ${data.length} 张图片已生成完毕！`;
            if(data.length > 0) {
                downloadAllBtn.style.display = 'inline-block';
            }
        }

        function loadImage(url) {
             return new Promise((resolve, reject) => {
                const proxyUrl = 'https://images.weserv.nl/?url=';
                const placeholderUrl = `https://placehold.co/600x400/EEE/333?text=Image+Load+Failed`;

                let finalUrl = placeholderUrl;
                if (url && url.trim()) {
                    const cleanedUrl = url.trim().replace(/^https?:\/\//, '');
                    finalUrl = `${proxyUrl}${cleanedUrl}`;
                }

                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = () => resolve(img);
                img.onerror = (err) => {
                    console.warn(`图片加载失败: ${url}. 使用占位图代替. Error:`, err);
                    const fallbackImg = new Image();
                    fallbackImg.src = placeholderUrl;
                    fallbackImg.onload = () => resolve(fallbackImg);
                    fallbackImg.onerror = reject;
                };
                img.src = finalUrl;
            });
        }
        
        async function generateImageCard(d, index) {
            const canvas = document.createElement('canvas');
            canvas.width = 1080;
            canvas.height = 1440;
            const ctx = canvas.getContext('2d');

            // 1. 绘制背景
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, 1080, 1440);
            
            // 2. 准备图片URLs
            let imageUrls = [];
            if (d.images && d.images.trim()) {
                const imageString = d.images.trim();
                if (imageString.startsWith('[') && imageString.endsWith(']')) {
                    try {
                        imageUrls = JSON.parse(imageString);
                    } catch (e) {
                        console.error('Could not parse images JSON string. Falling back to manual cleanup.', imageString, e);
                        imageUrls = imageString.replace(/[\[\]"]/g, '').split(',');
                    }
                } else {
                    imageUrls = imageString.split(',');
                }
                imageUrls = imageUrls.map(url => url.trim()).filter(Boolean);
            }

            const mainImageUrl = imageUrls[0] || '';
            const subImageUrls = imageUrls.slice(1, 4);
            while (subImageUrls.length < 3) subImageUrls.push('');


            // 3. 加载并绘制所有图片
            try {
                const [mainImg, subImg1, subImg2, subImg3] = await Promise.all([
                    loadImage(mainImageUrl),
                    loadImage(subImageUrls[0]),
                    loadImage(subImageUrls[1]),
                    loadImage(subImageUrls[2]),
                ]);

                // 绘制主图 (保持宽高比并裁剪)
                drawCoverImage(ctx, mainImg, 0, 0, 1080, 810);
                
                // 绘制三张副图（固定栅格：x=20/370/720，w=340，h=255，y=1165）
                drawCoverImage(ctx, subImg1, 20, 1165, 340, 255);
                drawCoverImage(ctx, subImg2, 370, 1165, 340, 255);
                drawCoverImage(ctx, subImg3, 720, 1165, 340, 255);

            } catch (error) {
                console.error('加载图片时出错:', error);
                // 占位：与新版布局一致（主图 1080×810 + 底部三图 340×255）
                ctx.fillStyle = TOKENS.BORDER;
                ctx.fillRect(0, 0, 1080, 810);
                // 三个缩略图占位
                ctx.fillRect(20, 1165, 340, 255);
                ctx.fillRect(370, 1165, 340, 255);
                ctx.fillRect(720, 1165, 340, 255);
            }
            
            // 4. 绘制 "家具房" 标签（颜色/阴影/圆角优化，统一到站内风格）
            if (d.is_furnished && d.is_furnished.toUpperCase() === 'YES') {
                const label = '家具房';
                const tagX = 40;
                const tagY = 40;
                const tagH = 36; // 胶囊高度
                ctx.save();
                ctx.font = `700 18px ${FAMILY}`;
                const textW = ctx.measureText(label).width;
                const padX = 16;
                const tagW = Math.ceil(textW) + padX * 2;

                // 阴影更克制
                ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
                ctx.shadowBlur = 8;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 2;

                ctx.fillStyle = '#dc2626';
                drawRoundedRect(ctx, tagX, tagY, tagW, tagH, tagH / 2);

                ctx.restore();
                ctx.fillStyle = '#ffffff';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = `700 18px ${FAMILY}`;
                ctx.fillText(label, tagX + tagW / 2, tagY + tagH / 2);
            }

            // 5. 绘制文字信息 (采用垂直流式布局)
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top'; // 使用 'top' 基线以便于计算Y坐标的流式布局

            let currentY = 840; // 文字起始位置（主图 810 + 间距 30）

            // --- 价格和地址组 ---
            const mainTextColor = TOKENS.PRIMARY;
            const addressTextColor = TOKENS.PRIMARY;
            const secondaryTextColor = TOKENS.SECONDARY;

            ctx.fillStyle = mainTextColor;

            // -- 绘制价格组（移除 $，与站内一致：22px 粗体 + 14px 次色“/周”） --
            let priceX = 40;
            const priceNumber = d.rent_pw || '价格待定';
            ctx.textBaseline = 'bottom';
            const priceBaselineY = currentY + SIZE.price;
            ctx.fillStyle = mainTextColor;
            ctx.font = `${TYPE.price} ${FAMILY}`;
            ctx.fillText(priceNumber, priceX, priceBaselineY);
            priceX += ctx.measureText(priceNumber).width;
            if (d.rent_pw) {
                ctx.fillStyle = secondaryTextColor;
                ctx.font = `${TYPE.unit} ${FAMILY}`;
                ctx.fillText(' /周', priceX, priceBaselineY);
            }
            currentY += SIZE.price + SPACE.md; // 价格块高22 + 12px 间距
            ctx.textBaseline = 'top';

            ctx.font = `${TYPE.address} ${FAMILY}`;
            ctx.fillStyle = addressTextColor;
            ctx.textBaseline = 'top';
            ctx.fillText(d.address || '地址未提供', 40, currentY);
            currentY += SIZE.address + SPACE.md; // 地址块高15 + 12px 间距

            // --- 房型图标组 ---
            const iconY = currentY;
            const numberY = iconY + ICON.size; // 数字与图标底线对齐（24px）
            
            // 绘制图标
            drawIcon(ctx, 'M3 20v-8a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v8 M5 10V6a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v4 M3 18h18', 40, iconY); // Bed
            drawIcon(ctx, 'M10 4 8 6 M17 19v2 M2 12h20 M7 19v2 M9 5 7.621 3.621A2.121 2.121 0 0 0 4 5v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-5', 190, iconY); // Bath
            drawIcon(ctx, 'm21 8-2 2-1.5-3.7A2 2 0 0 0 15.646 5H8.4a2 2 0 0 0-1.903 1.257L5 10 3 8 M7 14h.01 M17 14h.01 M5 10h14a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2Z M5 18v2 M19 18v2', 340, iconY); // Car
            
            // 绘制数字
            ctx.fillStyle = mainTextColor;
            ctx.font = `${TYPE.spec} ${FAMILY}`;
            ctx.textAlign = 'left'; 
            ctx.textBaseline = 'bottom';
            ctx.fillText(d.bedrooms || '0', 108, numberY);
            ctx.fillText(d.bathrooms || '0', 258, numberY);
            ctx.fillText(d.parking_spaces || '0', 408, numberY);
            
            currentY += ICON.size + SPACE.md; // 规格行高24 + 12px 间距

            // --- 日期和开放时间组 ---
            ctx.fillStyle = secondaryTextColor;
            ctx.font = `${TYPE.date} ${FAMILY}`;
            ctx.textBaseline = 'top';
            ctx.fillText(`空出日期: ${d.available_date || '待定'}`, 40, currentY);
            currentY += SIZE.date + SPACE.xs; // 日期13 + 4px 间距

            const inspectionText = d.inspection_times ? d.inspection_times.trim() : '需预约看房';
            ctx.fillStyle = TOKENS.LINK;
            ctx.font = `${TYPE.inspect} ${FAMILY}`;
            ctx.fillText(`开放时间: ${inspectionText}`, 40, currentY);
            

            // --- Append card to the grid ---
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-lg overflow-hidden flex flex-col';
            
            const imgEl = new Image();
            imgEl.src = canvas.toDataURL('image/jpeg', 0.9);
            imgEl.className = 'w-full h-auto';
            card.appendChild(imgEl);

            const downloadLink = document.createElement('a');
            downloadLink.href = imgEl.src;
            downloadLink.download = `property-${d.listing_id || index}.jpg`;
            downloadLink.className = 'mt-auto primary-btn text-white text-center font-bold py-3 px-4 transition duration-300';
            downloadLink.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>下载图片`;
            
            card.appendChild(downloadLink);
            resultsGrid.appendChild(card);
        }

        function drawRoundedRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
            ctx.fill();
        }

        function drawCoverImage(ctx, img, dx, dy, dWidth, dHeight) {
            const imgRatio = img.width / img.height;
            const canvasRatio = dWidth / dHeight;
            let sx, sy, sWidth, sHeight;

            if (imgRatio > canvasRatio) { // Image is wider than canvas area
                sHeight = img.height;
                sWidth = sHeight * canvasRatio;
                sx = (img.width - sWidth) / 2;
                sy = 0;
            } else { // Image is taller or same ratio
                sWidth = img.width;
                sHeight = sWidth / canvasRatio;
                sx = 0;
                sy = (img.height - sHeight) / 2;
            }
            ctx.drawImage(img, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);
        }
        
        function drawIcon(ctx, pathData, x, y) {
            ctx.save();
            ctx.strokeStyle = TOKENS.SECONDARY;
            ctx.lineWidth = ICON.stroke;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            const path = new Path2D(`M${x} ${y} ${pathData}`);
            
            const iconPath = new Path2D(pathData);
            ctx.translate(x, y);
            ctx.scale(1.8, 1.8); // 视觉约 24px，适配画布
            ctx.stroke(iconPath);
            ctx.restore();
        }

        // --- Download All Logic ---
        downloadAllBtn.addEventListener('click', async () => {
            downloadAllBtn.disabled = true;
            downloadAllBtn.textContent = '正在打包...';

            const zip = new JSZip();
            const imageCards = resultsGrid.querySelectorAll('.bg-white');

            imageCards.forEach((card, index) => {
                const img = card.querySelector('img');
                const downloadLink = card.querySelector('a');
                const fileName = downloadLink.download;
                const imgData = img.src.split(',')[1];
                zip.file(fileName, imgData, { base64: true });
            });

            const content = await zip.generateAsync({ type: 'blob' });
            saveAs(content, '房源图片.zip');

            downloadAllBtn.disabled = false;
            downloadAllBtn.textContent = '全部下载为 ZIP';
        });

    </script>
</body>
</html>
