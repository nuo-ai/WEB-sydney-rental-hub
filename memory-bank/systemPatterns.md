# 系统模式 (System Patterns)

**文档状态**: 生存文档 (Living Document)
**最后更新**: 2025-08-19

---

## 1. 核心系统架构

本项目采用**前后端分离**的现代 Web 架构，其核心数据流如下：

`前端 (Browser)` ↔️ `后端 API (FastAPI)` ↔️ `数据库 (Supabase)`

- **前端**: 纯粹的表示层，负责 UI 渲染和用户交互。
- **后端**: 业务逻辑、数据验证和数据库操作的唯一权威。
- **通信**: 前端通过向后端发送 RESTful API 请求进行通信。**前端绝不直接连接数据库**。

---

## 2. 后端设计模式 (基于代码审计的事实)

### 2.1. 双 API 架构
- **GraphQL API** (`/graphql`): 提供复杂的、结构化的数据查询能力，主要供高级客户端 (如 MCP 服务器、AI 助手) 使用。
- **RESTful API** (`/api/*`): 提供简单的数据获取接口，主要供前端应用使用。

### 2.2. 分层架构
- `api/`: API 层，定义 GraphQL Schema 和接口结构。
- `crud/`: 数据访问层，包含复杂的 SQL 查询逻辑，支持地理空间计算。
- `models/`: 数据模型层，使用 Strawberry + Pydantic 定义数据结构。
- `config/`: 配置层，包含大学数据等业务配置。

### 2.3. 地理空间计算系统
- **技术**: 基于 PostGIS 的复杂地理空间查询，支持距离计算、范围查询等。
- **功能**: 实现了步行、轻轨、火车、公交等多种交通方式的通勤时间计算。
- **数据模型**: 包含 `PropertyInfoForCommute`, `UniversityCommuteProfileResponse` 等专门的通勤计算模型。

### 2.4. 高级筛选系统
- **支持字段**: 20+ 种房源特征的布尔筛选 (空调、家具、阳台等)
- **日期范围**: 完整支持 `available_after` 和 `available_before` 参数
- **地理筛选**: 支持按区域、邮编、距离等地理条件筛选
- **分页**: 支持页码和游标两种分页模式

### 2.5. 异步任务处理
- **技术**: Celery + Redis 完整集成
- **API 端点**: `/api/tasks/debug`, `/api/tasks/db`, `/api/tasks/{task_id}` 等任务管理接口
- **应用场景**: 数据导入、批量计算、通知发送等后台任务

### 2.6. 企业级安全与性能
- **认证**: API Key + JWT 双重认证机制
- **限流**: slowapi 集成的请求频率限制
- **缓存**: Redis 缓存系统，支持 15 分钟房源列表缓存
- **异常处理**: 完整的异常处理和错误响应标准化

---

## 3. 前端设计模式 (基于 Old 版本的优秀实现)

### 3.1. 模块化 Vanilla JS 架构
- **技术**: **ES6 模块化 JavaScript**，通过 `import/export` 实现代码组织
- **UI 框架**: **TailwindCSS** 提供样式系统，**Font Awesome** 提供图标
- **交互增强**: 自定义 **UIEnhancer** 类，支持多种 UI 模式的动态切换

### 3.2. 状态管理模式
- **页面级状态**: 使用 JavaScript 对象 (`activeFilters`, `allProperties`) 管理页面状态
- **持久化状态**: 使用 `localStorage` 存储用户偏好和收藏数据
- **API 状态**: 通过 Promise-based 异步函数管理数据获取和更新

### 3.3. 高级 UX 模式
- **智能筛选面板**: 动态加载的筛选界面，支持价格滑块、多选按钮组等高级控件
- **图片轮播系统**: 完整的图片导航，包含方向控制和图片计数器
- **通勤计算集成**: Google Places API 自动补全 + Google Directions API 路线计算
- **响应式交互**: 实时筛选、预设目的地、多交通方式切换等流畅交互

### 3.4. 数据获取模式
- **API 集成**: 直接调用后端 RESTful API (`/api/properties`, `/api/properties/{id}`)
- **错误处理**: 完整的错误捕获和用户友好的错误信息显示
- **加载状态**: 动态加载指示器和状态管理

---

## 4. 关键学习与调试模式

- **分层调试**: 系统地解决问题，从网络层 (CORS) 到认证，再到数据/应用逻辑。
- **`curl` 是基本事实**: 在怀疑前端问题时，首先使用 `curl` 或 Postman 来建立后端 API 行为的基线，有效地将其与任何前端复杂性隔离开来。
- **对齐前后端契约**: 确保前端的 API 调用（端点、方法、数据结构）与后端提供的完全匹配，这是避免“数据显示不出来”这类问题的根本。

---
