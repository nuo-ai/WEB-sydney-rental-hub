---
const title = 'Tokens Playground (Astro)';
const desc = 'SRH Design Tokens Playground';

import '../../../../packages/ui/src/styles/tokens.css';
import '../../../../packages/ui/src/styles/tokens.dark.css';
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={desc} />
    <style>
      :root {
        --fg: var(--color-text-primary);
        --muted: var(--color-text-secondary);
        --border: var(--color-border);
        --bg: var(--color-background-page);
        --accent: var(--color-action-primary);

        /* SRH variables (runtime set via JS) */
        --srh-color-text-primary: var(--color-text-primary);
        --srh-color-text-secondary: var(--color-text-secondary);
        --srh-card-bg: var(--color-background-surface);
        --srh-shadow-card: var(--shadow-md);

        --srh-space-2xs: 4px;
        --srh-space-xs: 8px;
        --srh-space-sm: 12px;
        --srh-space-md: 16px;
        --srh-space-lg: 20px;

        --srh-radius-sm: 6px;
        --srh-radius-md: 8px;

        --srh-font-size-price: 20px;
        --srh-line-height-price: 28px;

        --srh-font-size-address: 16px;
        --srh-line-height-address: 24px;

        --srh-font-size-inspection: 14px;
        --srh-line-height-inspection: 20px;

        --srh-meta-icon-size: 16px;
        --srh-meta-gap: 8px;

        --srh-button-size: 40px;
        --srh-image-aspect: 0.75;

        /* typography */
        --srh-font-family-zh: 'PingFang SC', 'Source Han Sans SC', 'Noto Sans SC', 'Microsoft YaHei', 'Heiti SC', sans-serif;
        --srh-font-family-en: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
        --srh-font-family-base: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'PingFang SC', 'Source Han Sans SC', 'Noto Sans SC', 'Microsoft YaHei', 'Heiti SC', sans-serif;

        --srh-font-weight-regular: 400;
        --srh-font-weight-medium: 500;
        --srh-font-weight-semibold: 600;
        --srh-font-weight-bold: 700;

        --srh-letter-spacing-tight: -0.2px;
        --srh-letter-spacing-normal: 0px;
        --srh-letter-spacing-wide: 0.2px;

        --srh-font-size-xs: 12px;
        --srh-line-height-xs: 18px;
        --srh-font-size-sm: 14px;
        --srh-line-height-sm: 20px;
        --srh-font-size-md: 16px;
        --srh-line-height-md: 24px;
        --srh-font-size-lg: 20px;
        --srh-line-height-lg: 28px;
        --srh-font-size-xl: 24px;
        --srh-line-height-xl: 32px;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: var(--srh-font-family-base);
        color: var(--fg);
        background: var(--bg);
        letter-spacing: var(--srh-letter-spacing-normal);
        font-weight: var(--srh-font-weight-regular);
        font-size: var(--srh-font-size-md);
        line-height: var(--srh-line-height-md);
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 16px;
      }
      h1 { margin: 0 0 8px; font-size: 28px; }
      p.desc { color: var(--muted); margin: 0 0 20px; }
      .grid {
        display: grid;
        grid-template-columns: 380px 1fr;
        gap: 16px;
      }
      .panel {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px;
        background: var(--color-background-surface);
      }
      fieldset { border: none; padding: 0; margin: 0 0 12px; }
      legend { font-weight: 600; margin-bottom: 8px; }
      .row {
        display: flex; align-items: center; gap: 8px; margin: 6px 0;
      }
      .label { width: 170px; color: var(--muted); }
      input[type="number"], input[type="text"] {
        border: 1px solid #ddd; border-radius: 6px; padding: 6px 8px; height: 34px;
      }
      input[type="number"] { width: 120px; }
      input[type="color"] { width: 42px; height: 28px; padding: 0; border: 1px solid #ccc; }
      .actions { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
      .btn {
        display: inline-block; padding: 8px 12px; border-radius: 8px;
        text-decoration: none; cursor: pointer; border: 1px solid #ddd; background: #fafafa;
      }
      .btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }

      .preview-wrapper {
        background: #fafafa; border: 1px solid var(--border); border-radius: 10px; padding: 12px;
      }
      .card {
        width: 360px;
        background: var(--srh-card-bg);
        padding: var(--srh-space-md);
        box-shadow: var(--srh-shadow-card);
        border-radius: var(--srh-radius-md);
        font-family: var(--srh-font-family-base);
      }
      .img {
        width: 100%; height: 0;
        padding-top: calc(var(--srh-image-aspect) * 100%);
        background: #eee; border-radius: 6px; margin-bottom: 12px;
        position: relative;
      }
      .header { display: flex; align-items: center; justify-content: space-between; }
      .price {
        font-size: var(--srh-font-size-price);
        line-height: var(--srh-line-height-price);
        color: var(--srh-color-text-primary);
        font-weight: var(--srh-font-weight-semibold);
        letter-spacing: var(--srh-letter-spacing-tight);
      }
      .fav {
        width: var(--srh-button-size); height: var(--srh-button-size);
        border-radius: var(--srh-radius-md); background: #f5f5f5; color: #333;
        display: flex; align-items: center; justify-content: center;
      }
      .address {
        font-size: var(--srh-font-size-address);
        line-height: var(--srh-line-height-address);
        color: var(--srh-color-text-primary);
        letter-spacing: var(--srh-letter-spacing-normal);
        margin-top: 8px;
        font-weight: var(--srh-font-weight-regular);
      }
      .meta { display: flex; flex-direction: row; margin-top: 4px; }
      .meta-item { color: var(--srh-color-text-secondary); margin-right: var(--srh-meta-gap); }
      .meta-item:last-child { margin-right: 0; }
      .inspection {
        font-size: var(--srh-font-size-inspection);
        line-height: var(--srh-line-height-inspection);
        color: var(--srh-color-text-secondary);
        margin-top: 6px;
        letter-spacing: var(--srh-letter-spacing-wide);
        font-weight: var(--srh-font-weight-medium);
      }
    </style>
  </head>
  <body>
    <main class="container">
      <h1>Tokens Playground</h1>
      <p class="desc">从左侧调整 Token（含字体家族/字重/字距/字号级别），右侧预览卡片将实时更新。可复制 JSON 或 SCSS，回填到小程序/WEB 项目。</p>
      <p style="margin: 6px 0 16px;">
        <a href="/tokens/blackwhite" class="btn">打开 Black & White Design Tokens 页面</a>
      </p>

      <div style="margin: 12px 0 16px;">
        <button class="btn primary" id="theme-toggle" type="button">切换暗色</button>
        <span style="margin-left: 8px; color: var(--muted); font-size: 13px;">当前主题通过 [data-theme] 控制</span>
      </div>

      <div class="grid">
        <div class="panel">
          <fieldset>
            <legend>颜色</legend>
            <div class="row">
              <span class="label">colorTextPrimary</span>
              <input id="colorTextPrimaryPicker" type="color" />
              <input id="colorTextPrimary" type="text" />
            </div>
            <div class="row">
              <span class="label">colorTextSecondary</span>
              <input id="colorTextSecondaryPicker" type="color" />
              <input id="colorTextSecondary" type="text" />
            </div>
            <div class="row">
              <span class="label">cardBg</span>
              <input id="cardBgPicker" type="color" />
              <input id="cardBg" type="text" />
            </div>
          </fieldset>

          <fieldset>
            <legend>阴影</legend>
            <div class="row">
              <span class="label">shadow</span>
              <input id="shadow" type="text" placeholder="例如：0 2px 8px 0 rgba(0,0,0,.2)" style="flex:1;" />
            </div>
          </fieldset>

          <fieldset>
            <legend>尺寸（px）</legend>
            <div class="row"><span class="label">space2xs</span><input id="space2xs" type="number" /></div>
            <div class="row"><span class="label">spaceXs</span><input id="spaceXs" type="number" /></div>
            <div class="row"><span class="label">spaceSm</span><input id="spaceSm" type="number" /></div>
            <div class="row"><span class="label">spaceMd</span><input id="spaceMd" type="number" /></div>
            <div class="row"><span class="label">spaceLg</span><input id="spaceLg" type="number" /></div>
            <div class="row"><span class="label">radiusSm</span><input id="radiusSm" type="number" /></div>
            <div class="row"><span class="label">radiusMd</span><input id="radiusMd" type="number" /></div>
            <div class="row"><span class="label">metaIconSize</span><input id="metaIconSize" type="number" /></div>
            <div class="row"><span class="label">metaGap</span><input id="metaGap" type="number" /></div>
            <div class="row"><span class="label">buttonSize</span><input id="buttonSize" type="number" /></div>
            <div class="row"><span class="label">imageAspect</span><input id="imageAspect" type="number" step="0.01" /></div>
          </fieldset>

          <fieldset>
            <legend>Typography · 字体家族</legend>
            <div class="row">
              <span class="label">fontFamilyEN（英文）</span>
              <input id="fontFamilyEN" type="text" style="flex:1;" placeholder="-apple-system, Roboto, ..." />
            </div>
            <div class="row">
              <span class="label">fontFamilyZH（中文）</span>
              <input id="fontFamilyZH" type="text" style="flex:1;" placeholder="'PingFang SC', 'Source Han Sans SC', ..." />
            </div>
          </fieldset>

          <fieldset>
            <legend>Typography · 字重与字距</legend>
            <div class="row"><span class="label">fontWeightRegular</span><input id="fontWeightRegular" type="number" /></div>
            <div class="row"><span class="label">fontWeightMedium</span><input id="fontWeightMedium" type="number" /></div>
            <div class="row"><span class="label">fontWeightSemibold</span><input id="fontWeightSemibold" type="number" /></div>
            <div class="row"><span class="label">fontWeightBold</span><input id="fontWeightBold" type="number" /></div>
            <div class="row"><span class="label">letterSpacingTight(px)</span><input id="letterSpacingTight" type="number" step="0.1" /></div>
            <div class="row"><span class="label">letterSpacingNormal(px)</span><input id="letterSpacingNormal" type="number" step="0.1" /></div>
            <div class="row"><span class="label">letterSpacingWide(px)</span><input id="letterSpacingWide" type="number" step="0.1" /></div>
          </fieldset>

          <fieldset>
            <legend>Typography · 文本级别（px）</legend>
            <div class="row"><span class="label">XS size / line</span><input id="fontSizeXs" type="number" /><input id="lineHeightXs" type="number" /></div>
            <div class="row"><span class="label">SM size / line</span><input id="fontSizeSm" type="number" /><input id="lineHeightSm" type="number" /></div>
            <div class="row"><span class="label">MD size / line</span><input id="fontSizeMd" type="number" /><input id="lineHeightMd" type="number" /></div>
            <div class="row"><span class="label">LG size / line</span><input id="fontSizeLg" type="number" /><input id="lineHeightLg" type="number" /></div>
            <div class="row"><span class="label">XL size / line</span><input id="fontSizeXl" type="number" /><input id="lineHeightXl" type="number" /></div>
          </fieldset>

          <fieldset>
            <legend>卡片专用（覆盖通用级别）</legend>
            <div class="row"><span class="label">price size / line</span><input id="fontSizePrice" type="number" /><input id="lineHeightPrice" type="number" /></div>
            <div class="row"><span class="label">address size / line</span><input id="fontSizeAddress" type="number" /><input id="lineHeightAddress" type="number" /></div>
            <div class="row"><span class="label">inspection size / line</span><input id="fontSizeInspection" type="number" /><input id="lineHeightInspection" type="number" /></div>
          </fieldset>

          <div class="actions">
            <button id="resetBtn" class="btn">重置</button>
            <button id="copyJsonBtn" class="btn primary">复制 JSON</button>
            <button id="copyScssBtn" class="btn">复制 SCSS</button>
          </div>
        </div>

        <div>
          <div class="preview-wrapper">
            <div class="card">
              <div class="img" id="img"></div>
              <div class="header">
                <div class="price">$800 pw</div>
                <div class="fav" aria-label="fav" title="Favorite">♥</div>
              </div>
              <div class="address">12 Example St, Zetland NSW 2017</div>
              <div class="meta">
                <div class="meta-item">2 Bed</div>
                <div class="meta-item">2 Bath</div>
                <div class="meta-item">1 Car</div>
              </div>
              <div class="inspection">Inspection today 2:15pm</div>
            </div>
          </div>

          <details style="margin-top: 16px;">
            <summary>当前 JSON</summary>
            <pre id="jsonView" style="background:#f6f8fa; padding:12px; border-radius:8px; overflow:auto;"></pre>
          </details>

          <details style="margin-top: 12px;">
            <summary>回填 SCSS（复制到 apps/uni-app/src/uni.scss）</summary>
            <pre id="scssView" style="background:#f6f8fa; padding:12px; border-radius:8px; overflow:auto;"></pre>
          </details>
        </div>
      </div>
    </main>

    <script>
      const numberKeysPx = [
        'space2xs','spaceXs','spaceSm','spaceMd','spaceLg',
        'radiusSm','radiusMd',
        'fontSizePrice','lineHeightPrice',
        'fontSizeAddress','lineHeightAddress',
        'fontSizeInspection','lineHeightInspection',
        'metaIconSize','metaGap',
        'buttonSize'
      ];

      const colorKeys = ['colorTextPrimary', 'colorTextSecondary', 'cardBg'];
      const otherKeys = ['shadow', 'imageAspect'];

      const fontKeys = ['fontFamilyEN','fontFamilyZH'];
      const weightKeys = ['fontWeightRegular','fontWeightMedium','fontWeightSemibold','fontWeightBold'];
      const letterKeys = ['letterSpacingTight','letterSpacingNormal','letterSpacingWide'];
      const scaleSizeKeys = ['fontSizeXs','fontSizeSm','fontSizeMd','fontSizeLg','fontSizeXl'];
      const scaleLineKeys = ['lineHeightXs','lineHeightSm','lineHeightMd','lineHeightLg','lineHeightXl'];

      // --- Theme-aware Token Playground ---

      // All token keys managed by this playground
      const allTokenKeys = {
        color: ['colorTextPrimary', 'colorTextSecondary', 'cardBg'],
        shadow: ['shadow'],
        number: [
          'space2xs','spaceXs','spaceSm','spaceMd','spaceLg',
          'radiusSm','radiusMd', 'metaIconSize','metaGap', 'buttonSize',
          'imageAspect', 'fontWeightRegular','fontWeightMedium','fontWeightSemibold','fontWeightBold',
          'letterSpacingTight','letterSpacingNormal','letterSpacingWide',
          'fontSizeXs','lineHeightXs', 'fontSizeSm','lineHeightSm', 'fontSizeMd','lineHeightMd',
          'fontSizeLg','lineHeightLg', 'fontSizeXl','lineHeightXl',
          'fontSizePrice','lineHeightPrice', 'fontSizeAddress','lineHeightAddress',
          'fontSizeInspection','lineHeightInspection'
        ],
        string: ['fontFamilyEN', 'fontFamilyZH']
      };

      // Mapping from playground token names to CSS custom property names
      const keyToCssVar = {
        colorTextPrimary: '--srh-color-text-primary',
        colorTextSecondary: '--srh-color-text-secondary',
        cardBg: '--srh-card-bg',
        shadow: '--srh-shadow-card',
        space2xs: '--srh-space-2xs',
        spaceXs: '--srh-space-xs',
        spaceSm: '--srh-space-sm',
        spaceMd: '--srh-space-md',
        spaceLg: '--srh-space-lg',
        radiusSm: '--srh-radius-sm',
        radiusMd: '--srh-radius-md',
        metaIconSize: '--srh-meta-icon-size',
        metaGap: '--srh-meta-gap',
        buttonSize: '--srh-button-size',
        imageAspect: '--srh-image-aspect',
        fontFamilyEN: '--srh-font-family-en',
        fontFamilyZH: '--srh-font-family-zh',
        fontWeightRegular: '--srh-font-weight-regular',
        fontWeightMedium: '--srh-font-weight-medium',
        fontWeightSemibold: '--srh-font-weight-semibold',
        fontWeightBold: '--srh-font-weight-bold',
        letterSpacingTight: '--srh-letter-spacing-tight',
        letterSpacingNormal: '--srh-letter-spacing-normal',
        letterSpacingWide: '--srh-letter-spacing-wide',
        fontSizeXs: '--srh-font-size-xs',
        lineHeightXs: '--srh-line-height-xs',
        fontSizeSm: '--srh-font-size-sm',
        lineHeightSm: '--srh-line-height-sm',
        fontSizeMd: '--srh-font-size-md',
        lineHeightMd: '--srh-line-height-md',
        fontSizeLg: '--srh-font-size-lg',
        lineHeightLg: '--srh-line-height-lg',
        fontSizeXl: '--srh-font-size-xl',
        lineHeightXl: '--srh-line-height-xl',
        fontSizePrice: '--srh-font-size-price',
        lineHeightPrice: '--srh-line-height-price',
        fontSizeAddress: '--srh-font-size-address',
        lineHeightAddress: '--srh-line-height-address',
        fontSizeInspection: '--srh-font-size-inspection',
        lineHeightInspection: '--srh-line-height-inspection',
      };

      let tokens = {}; // The current state of all tokens

      // --- Helper Functions ---
      function el(id) { return document.getElementById(id); }
      function toPx(v) { const n = Number(v); return Number.isFinite(n) ? `${n}px` : String(v); }

      // --- Core Logic ---

      // Applies a single token value as an inline style on the root element.
      function applyToken(key, value) {
        const cssVar = keyToCssVar[key];
        if (!cssVar) return;

        let finalValue = String(value);
        if (allTokenKeys.number.includes(key) && key !== 'imageAspect' && !key.startsWith('fontWeight')) {
          finalValue = toPx(value);
        }
        document.documentElement.style.setProperty(cssVar, finalValue);
      }

      // Reads the current theme's CSS variables and populates the `tokens` object and UI controls.
      function initFromTheme() {
        const cs = getComputedStyle(document.documentElement);
        const newTokens = {};

        for (const key in keyToCssVar) {
          const cssVar = keyToCssVar[key];
          let value = (cs.getPropertyValue(cssVar) || '').trim();

          if (allTokenKeys.number.includes(key)) {
            value = parseFloat(value) || 0;
          }
          newTokens[key] = value;
        }
        tokens = newTokens;
        updateUIControls();
        updateViews();
      }

      // Updates the input controls on the left panel with current token values.
      function updateUIControls() {
        for (const key in tokens) {
          const input = el(key);
          if (input) input.value = tokens[key];
          if (allTokenKeys.color.includes(key)) {
            const picker = el(`${key}Picker`);
            if (picker) picker.value = tokens[key];
          }
        }
      }

      // Updates the JSON and SCSS preview areas.
      function updateViews() {
        el('jsonView').textContent = JSON.stringify(tokens, null, 2);
        el('scssView').textContent = generateScss(tokens);
      }

      // Binds event listeners to all input controls.
      function bindInputs() {
        for (const key in keyToCssVar) {
          const input = el(key);
          if (!input) continue;

          const eventType = 'input';
          input.addEventListener(eventType, (e) => {
            let value = e.target.value;
            if (allTokenKeys.number.includes(key)) {
              value = parseFloat(value) || 0;
            }
            tokens[key] = value;
            applyToken(key, value);
            updateViews();
            if (allTokenKeys.color.includes(key)) {
              const picker = el(`${key}Picker`);
              if (picker) picker.value = value;
            }
          });

          if (allTokenKeys.color.includes(key)) {
            const picker = el(`${key}Picker`);
            if (picker) {
              picker.addEventListener('input', (e) => {
                tokens[key] = e.target.value;
                applyToken(key, e.target.value);
                updateViews();
                if (input) input.value = e.target.value;
              });
            }
          }
        }
      }

      // --- SCSS/JSON Generation and Download ---
      function generateScss(vars) {
        const map = [
          ['colorTextPrimary', '$srh-color-text-primary', v=>v], ['colorTextSecondary', '$srh-color-text-secondary', v=>v],
          ['cardBg', '$srh-color-card-bg', v=>v], ['shadow', '$srh-shadow-card', v=>v],
          ['space2xs', '$srh-space-2xs', v=>toPx(v)], ['spaceXs', '$srh-space-xs', v=>toPx(v)],
          ['spaceSm', '$srh-space-sm', v=>toPx(v)], ['spaceMd', '$srh-space-md', v=>toPx(v)],
          ['spaceLg', '$srh-space-lg', v=>toPx(v)], ['radiusSm', '$srh-radius-sm', v=>toPx(v)],
          ['radiusMd', '$srh-radius-md', v=>toPx(v)], ['metaIconSize', '$srh-meta-icon-size', v=>toPx(v)],
          ['metaGap', '$srh-meta-gap', v=>toPx(v)], ['buttonSize', '$srh-button-size', v=>toPx(v)],
          ['imageAspect', '$srh-image-aspect', v=>String(v)], ['fontFamilyEN', '$srh-font-family-en', v=>v],
          ['fontFamilyZH', '$srh-font-family-zh', v=>v], ['fontWeightRegular', '$srh-font-weight-regular', v=>v],
          ['fontWeightMedium', '$srh-font-weight-medium', v=>v], ['fontWeightSemibold', '$srh-font-weight-semibold', v=>v],
          ['fontWeightBold', '$srh-font-weight-bold', v=>v], ['letterSpacingTight', '$srh-letter-spacing-tight', v=>toPx(v)],
          ['letterSpacingNormal', '$srh-letter-spacing-normal', v=>toPx(v)], ['letterSpacingWide', '$srh-letter-spacing-wide', v=>toPx(v)],
          ['fontSizeXs', '$srh-font-size-xs', v=>toPx(v)], ['lineHeightXs', '$srh-line-height-xs', v=>toPx(v)],
          ['fontSizeSm', '$srh-font-size-sm', v=>toPx(v)], ['lineHeightSm', '$srh-line-height-sm', v=>toPx(v)],
          ['fontSizeMd', '$srh-font-size-md', v=>toPx(v)], ['lineHeightMd', '$srh-line-height-md', v=>toPx(v)],
          ['fontSizeLg', '$srh-font-size-lg', v=>toPx(v)], ['lineHeightLg', '$srh-line-height-lg', v=>toPx(v)],
          ['fontSizeXl', '$srh-font-size-xl', v=>toPx(v)], ['lineHeightXl', '$srh-line-height-xl', v=>toPx(v)],
          ['fontSizePrice', '$srh-font-size-price', v=>toPx(v)], ['lineHeightPrice', '$srh-line-height-price', v=>toPx(v)],
          ['fontSizeAddress', '$srh-font-size-address', v=>toPx(v)], ['lineHeightAddress', '$srh-line-height-address', v=>toPx(v)],
          ['fontSizeInspection', '$srh-font-size-inspection', v=>toPx(v)], ['lineHeightInspection', '$srh-line-height-inspection', v=>toPx(v)]
        ];
        const lines = ['/* 由 Astro 站点导出，回填到 apps/uni-app/src/uni.scss */'];
        for (const [k, scss, fmt] of map) {
          if (vars[k] !== undefined) lines.push(`${scss}: ${fmt(vars[k])};`);
        }
        return lines.join('\n');
      }

      function download(filename, text) {
        const blob = new Blob([text], { type: 'application/json;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      async function copyJSON() {
        const text = JSON.stringify(tokens, null, 2);
        try { await navigator.clipboard.writeText(text); alert('已复制 JSON'); }
        catch { download('srh.tokens.json', text); }
      }
      async function copySCSS() {
        const text = generateScss(tokens);
        try { await navigator.clipboard.writeText(text); alert('已复制 SCSS'); }
        catch { download('srh.tokens.scss', text); }
      }

      // --- Initialization and Event Binding ---

      // Reset to current theme values
      document.getElementById('resetBtn').addEventListener('click', initFromTheme);
      document.getElementById('copyJsonBtn').addEventListener('click', copyJSON);
      document.getElementById('copyScssBtn').addEventListener('click', copySCSS);

      // Initial load
      document.addEventListener('DOMContentLoaded', () => {
        initFromTheme();
        bindInputs();

        // Observe theme changes
        const observer = new MutationObserver((mutations) => {
          for (const mutation of mutations) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
              // Use a timeout to ensure computed styles are updated after the theme switch
              setTimeout(initFromTheme, 50);
            }
          }
        });
        observer.observe(document.documentElement, { attributes: true });
      });
    </script>

    <script>
      (function() {
        const root = document.documentElement;
        const key = 'srh-theme';
        const apply = (t) => {
          if (t === 'dark') root.setAttribute('data-theme', 'dark');
          else root.removeAttribute('data-theme');
          try { localStorage.setItem(key, t); } catch (e) {}
        };
        try {
          const saved = localStorage.getItem(key);
          if (saved) apply(saved);
          else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) apply('dark');
        } catch(e) {}
        const btn = document.getElementById('theme-toggle');
        if (btn) {
          const syncLabel = () => {
            const isDark = root.getAttribute('data-theme') === 'dark';
            btn.textContent = isDark ? '切换浅色' : '切换暗色';
          };
          btn.addEventListener('click', () => {
            const isDark = root.getAttribute('data-theme') === 'dark';
            apply(isDark ? 'light' : 'dark');
            syncLabel();
          });
          syncLabel();
        }
      })();
    </script>
  </body>
</html>
