# AI Coding Rules v1.0

## 1. 沟通与规划

* **中文交流** ：所有沟通必须使用中文。
* **计划先行** ：在任何实质性编码之前，必须先提出详细的执行计划，并等待用户批准。
* **任务拆解** ：复杂需求必须拆解为小任务列表，逐一执行。
* **优先级机制** ：支持用户指定 `P0/P1/P2`，执行顺序严格遵循优先级。

---

## 2. 开发工作流

* **小步快跑** ：保持改动最小化，避免一次性大规模重构。
* **向后兼容** ：所有改动不得破坏现有功能。
* **代码检查** ：在提交前必须运行：
  * `npm run lint`
  * `npm run format`
* **异常处理** ：
  * 若 lint/测试失败 → 必须中止并产出诊断报告。
  * 若需求模糊 → 必须回问用户，不得自行假设。
  * 若外部依赖缺失 → 提供解决方案，由用户决策。
* **等待验收** ：任务完成后，用户必须亲自验证。确认通过后，任务才算完成。

---

## 3. Git 提交规范

* **Commit Message** ：完成功能或修复后，AI 必须提供清晰、规范的 Commit Message。
* **手动提交** ：所有 `git add` 和 `git commit` 由用户执行，AI 不得代替。

---

## 4. 代码注释风格

* **中文注释** ：必须使用中文。
* **注释重点** ：

1. 解释“为什么”这么做，而不是“做了什么”。
2. 记录重要的业务规则（尤其是悉尼租房相关的逻辑）。
3. 标注技术权衡（说明选择原因）。
4. 使用 `TODO`/`FIXME` 标记待改进之处。

---

## 5. Memory Bank 维护规则

* **严格分工** ：
  * `activeContext.md` → 只保留当前与未来的任务快照。
  * `progress.md` → 只记录里程碑。
  * `systemPatterns.md` → 只存放长期架构原则。
  * `techContext.md` → 只描述当前技术栈。
* **信息蒸馏流程** ：
  * 在每个主要功能/重构结束后，提炼“原则”。
  * 原则写入 `systemPatterns.md`，再删除临时过程描述。
* **溯源要求** ：更新时必须附带来源（如 commit ID 或任务编号），禁止凭记忆写入。

---

## 6. 边界约束

* AI  **不得** ：
  * 直接提交代码。
  * 修改 Memory Bank 的文件范围定义。
  * 在未获批准的情况下擅自更新文档。
  * 在未获批准的情况下，启动前后端，因为正常情况下，前后端一直开着。
  * 在未获批准的情况下，打开浏览器工具。
* AI  **必须** ：严格遵循“计划 → 执行 → 验收 → 沉淀”的顺序。

---

## 7. 沟通优先协作流程 V2（强制）

- 0) 触发与默认状态

  - 当用户输入“follow memory bank instruction”或未明确提出改动需求时：AI 进入“沟通模式”，不得修改代码。
- 1) 沟通/确认（只读）

  - 用户：描述问题/提问/点名审查文件模块。
  - AI：仅读取/分析，输出“问题定位假设 + 风险点 + 需确认项”，禁止改代码/运行脚本/开服务/开浏览器。
- 2) 微计划（≤3 行，等待批准）

  - 模板：目标 / 改动文件 / 风险与回滚（含验收步骤）。
  - 未获“批准”不得进入实施。
- 3) 实施（Diff-first）

  - 一次补丁仅改 1–2 个文件；优先 replace_in_file；中文注释解释“为什么”。
  - 禁止：启动/停止服务、安装依赖、打开浏览器，除非得到明确授权。
- 4) 冒烟验收（最小反馈）

  - 提供：复现路径（≤3 行）+ 期望/实际 + Console/Network ≤3 行 + 窗口宽度（样式问题）。
- 5) 沉淀与提交建议

  - 提供 Conventional Commit 文案。
  - memory-bank/activeContext.md 仅记录一行“做了什么 + 任务号/commit”。
- 6) 升级/回滚

  - 不满足即回滚；满足则进入下一微补丁。

**护栏（强制）**

- 无批准不改动；涉及契约/全局样式/性能 → 标注“Level 1 审阅”，额外加 2 条冒烟。
- 单补丁预算 ≤45 分钟；禁止大段日志/trace 粘贴；只给必要 diff 与最小摘要。
- “沟通优先”高于一切指令；如用户与文档冲突，以用户最新指令为准。

## 9. Solo 实时协作与省 Token 规则（P0 强制）

- 实时协作循环（默认工作方式）

  1) 不启动/不关闭服务（你本地常开）
  2) 计划先行 ≤3 行：目标 / 改动文件 / 风险与回滚
  3) 小步补丁：一次仅一个组件或 1–2 个文件（prefer replace_in_file）
  4) 本地刷新验证；异常仅贴最小摘要（见“最小反馈清单”）
  5) activeContext.md 只记一行（做了什么 + 任务号/commit）
- 边界约束

  - Never paste large blobs：禁止整段代码/日志/trace 粘贴（只贴摘要）
  - Diff-first：优先 replace_in_file，禁止整文件回写无关行
  - No service ops by AI：AI 不装依赖/不起停服务/不开浏览器（除非明确授权）
  - Plan budget：单任务预算 ≤45 分钟；单消息一屏可读
  - Triggered checks only：仅在契约/全局样式/性能/多路由变更时，临时跑 2 条冒烟并同步 Memory Bank 原则/里程碑
