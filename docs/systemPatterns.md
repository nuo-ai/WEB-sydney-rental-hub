# 系统架构模式 (systemPatterns.md)

## 🚀 最新更新：项目重组架构 (2025年7月7日)

### 新的模块化项目结构
```
sydney-rental-platform/
├── frontend/              # 前端应用 (端口8080)
│   ├── index.html        # 主页面
│   ├── details.html      # 房源详情
│   ├── scripts/          # JavaScript模块
│   └── functions/        # Netlify云函数
├── backend/              # 后端API (端口8000)
│   ├── main.py          # FastAPI主入口
│   ├── db.py            # 数据库连接
│   ├── api/             # GraphQL接口
│   ├── models/          # 数据模型
│   └── crud/            # 数据操作层
├── mcp-server/          # MCP服务器 (为Cline提供工具)
│   ├── src/             # TypeScript源码
│   ├── build/           # 编译后JS
│   └── package.json     # Node.js依赖
├── database/            # 数据库相关
│   ├── setup_database.sql      # 数据库初始化
│   ├── process_csv.py          # ETL数据处理
│   └── *.sql                   # 其他SQL脚本
├── scripts/             # 管理脚本
│   ├── run_backend.py          # 启动后端
│   ├── start_all.py            # 一键启动
│   └── test_api.py             # API测试
├── docs/               # 项目文档 (原memory-bank)
└── .env               # 环境变量配置
```

## 1. 整体架构

### 架构风格
- **模块化分离架构**: 前端、后端、MCP服务、数据库、脚本完全分离
- **多服务协同**: FastAPI后端 + MCP工具服务 + 前端应用
- **GraphQL API中心**: 使用GraphQL进行数据查询和操作
- **PowerShell兼容**: 所有命令和脚本支持Windows PowerShell环境

### 系统组件关系
```
┌─────────────────┐    GraphQL/HTTP    ┌─────────────────┐
│   前端应用       │ ◄─────────────────► │  后端API服务     │
│  frontend/      │   (localhost:8080)  │  backend/       │
│  (HTML/CSS/JS)  │                    │  (FastAPI)      │
└─────────────────┘                    └─────────────────┘
                                                │
                                                │ SQL查询
                                                ▼
┌─────────────────┐    stdio通信       ┌─────────────────┐
│   MCP服务器      │ ◄─────────────────► │  PostgreSQL     │
│  mcp-server/    │   (为Cline提供工具)  │  + PostGIS      │
│  (Node.js/TS)   │                    │  database/      │
└─────────────────┘                    └─────────────────┘
                                                ▲
                                                │ ETL处理
                                                │
                                       ┌─────────────────┐
                                       │  管理脚本        │
                                       │  scripts/       │
                                       │  (Python)       │
                                       └─────────────────┘
```

## 2. 核心设计模式

### 数据访问模式
- **Repository Pattern**: 数据访问层抽象，便于测试和维护
- **GraphQL Schema First**: 先定义GraphQL schema，再实现resolver
- **地理空间数据处理**: 使用PostGIS扩展处理地理位置和距离计算

### API设计模式
- **GraphQL单端点**: 所有数据查询通过单一GraphQL端点
- **类型安全**: 使用Strawberry-GraphQL确保类型安全
- **批量查询优化**: GraphQL天然支持批量数据获取，减少网络请求

### 前端架构模式
- **组件化开发**: 将UI拆分为可复用的组件
- **状态管理**: 使用localStorage进行客户端状态持久化
- **响应式设计**: 使用Tailwind CSS实现移动端适配

## 3. 关键技术决策

### 为什么选择GraphQL而不是REST?
1. **灵活的数据查询**: 前端可以精确指定需要的数据字段
2. **减少网络请求**: 一次请求获取多个相关资源
3. **强类型系统**: 自动生成API文档和类型检查
4. **适合复杂查询**: 房源搜索涉及多维度筛选和排序

### 为什么选择FastAPI?
1. **高性能**: 基于Starlette和Pydantic，性能优异
2. **自动文档生成**: 内置Swagger UI支持
3. **类型提示**: 原生支持Python类型提示
4. **异步支持**: 天然支持async/await

### 为什么选择PostgreSQL + PostGIS?
1. **地理空间支持**: PostGIS提供强大的地理空间查询能力
2. **ACID事务**: 确保数据一致性
3. **成熟稳定**: 企业级数据库，社区支持完善
4. **JSON支持**: 原生支持JSON数据类型

## 4. 数据流模式

### 房源搜索流程
```
用户输入 → 前端验证 → GraphQL查询 → 后端处理 → 数据库查询 → 地理计算 → 结果排序 → 返回前端 → UI渲染
```

### 用户认证流程
```
登录请求 → 后端验证 → JWT生成 → 前端存储 → 后续请求携带Token → 后端验证Token → 授权访问
```

### 收藏功能流程
```
用户操作 → 前端状态更新 → API调用 → 数据库更新 → 响应确认 → UI状态同步
```

## 5. 扩展性考虑

### 水平扩展
- **无状态后端**: FastAPI应用无状态，支持多实例部署
- **数据库连接池**: 使用连接池管理数据库连接
- **CDN部署**: 前端静态资源通过CDN分发

### 功能扩展
- **微服务拆分**: 未来可将认证、支付等功能拆分为独立服务
- **缓存层**: 可添加Redis缓存热点数据
- **消息队列**: 可引入消息队列处理异步任务

## 6. 安全模式

### 认证授权
- **JWT Token**: 使用JWT进行用户认证
- **HTTPS**: 所有API通信使用HTTPS加密
- **CORS配置**: 严格配置跨域访问策略

### 数据安全
- **SQL注入防护**: 使用参数化查询
- **输入验证**: Pydantic模型验证所有输入数据
- **敏感信息保护**: 密码哈希存储，不记录敏感日志

## 7. 监控和运维模式

### 日志记录
- **结构化日志**: 使用JSON格式记录日志
- **分级日志**: 区分DEBUG、INFO、WARNING、ERROR级别
- **请求追踪**: 记录API请求和响应时间

### 健康检查
- **API健康检查**: 提供/health端点检查服务状态
- **数据库连接检查**: 监控数据库连接状态
- **依赖服务检查**: 检查第三方服务可用性

## 8. 手动数据管道 (ETL) 模式

### 架构概述
- **手动触发**: 整个ETL流程由开发者手动执行脚本来启动。
- **批处理模式**: 每次爬取的数据作为一个批次进行处理。
- **状态化数据管理**: 数据库中记录房源的完整生命周期（新增、更新、下架）。

### 数据管道流程
```mermaid
graph TD
    A[开发者手动运行\n(run_etl_once.py)] --> B{执行爬虫脚本\n(v2.py)};
    B --> C[生成带时间戳的CSV];
    A --> D{执行数据处理脚本\n(update_database.py)};
    C --> D;
    D <--> E[PostgreSQL数据库\n(带is_active, created_at等字段)];
    subgraph "数据处理逻辑"
        D --> F{识别新增房源};
        D --> G{更新现有房源};
        D --> H{标记下架房源};
    end
```

### 关键设计决策
- **软删除 (Soft Deletion)**: 对于已下架的房源，使用 `is_active = false` 标记而不是物理删除。这保留了历史数据，便于未来进行市场趋势分析。
- **数据版本控制**: 每次爬取都生成独立的CSV文件，提供了数据溯源和故障恢复的能力。
- **幂等性操作**: 数据处理脚本应设计为幂等的，即多次运行同一个新数据文件不会产生副作用（如重复插入数据）。
- **手动控制**: ETL流程由开发者完全手动控制，确保了在数据更新过程中的可预见性和可控性。
