#!/usr/bin/env bash
set -euo pipefail

echo "üîé Pre-commit checks: lint + typecheck"

PROJECT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$PROJECT_ROOT"

# 1) Frontend ESLint (reuses existing script logic)
if [ -d "apps/web" ]; then
  echo "‚Ä¢ Frontend: ESLint"
  pnpm --filter @web-sydney/web lint

  echo "‚Ä¢ Frontend: Stylelint"
  if pnpm --filter @web-sydney/web exec -- stylelint --version >/dev/null 2>&1; then
    pnpm --filter @web-sydney/web lint:style
  else
    echo "  ‚Ü™Ô∏é Stylelint skipped (binary not found)"
  fi
fi

# 2) TypeScript typecheck for MCP server (no emit)
if [ -d "apps/mcp-server" ]; then
  echo "‚Ä¢ MCP Server: TypeScript typecheck"
  if pnpm --filter @web-sydney/mcp-server exec -- tsc --noEmit >/dev/null 2>&1; then
    pnpm --filter @web-sydney/mcp-server exec -- tsc --noEmit
  else
    pnpm --filter @web-sydney/mcp-server build
  fi
fi

# 3) Python syntax check (fast, no dependencies)
echo "‚Ä¢ Python: syntax check (compileall)"
python -m compileall -q backend scripts database crawler || {
  echo "‚ùå Python syntax errors detected";
  exit 1;
}

# 4) Extra local checks (if you maintain scripts/pre-commit.sh)
if [ -f "scripts/pre-commit.sh" ]; then
  echo "‚Ä¢ Running extra repo checks (scripts/pre-commit.sh)"
  bash scripts/pre-commit.sh || {
    echo "‚ùå scripts/pre-commit.sh failed";
    exit 1;
  }
fi

echo "‚úÖ All pre-commit checks passed"
