#!/usr/bin/env bash
set -euo pipefail

echo "üîé Pre-commit checks: lint + typecheck"

PROJECT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$PROJECT_ROOT"

# 1) Frontend ESLint (reuses existing script logic)
if [ -d "vue-frontend" ]; then
  echo "‚Ä¢ Frontend: ESLint"
  (cd vue-frontend && npm run -s lint)

  # Conditionally run Stylelint if available to enforce Design Token guardrails
  if [ -x "vue-frontend/node_modules/.bin/stylelint" ]; then
    echo "‚Ä¢ Frontend: Stylelint"
    (cd vue-frontend && npm run -s lint:style)
  else
    echo "‚Ä¢ Frontend: Stylelint skipped (binary not found)"
  fi
fi

# 2) TypeScript typecheck for MCP server (no emit)
if [ -d "mcp-server" ]; then
  echo "‚Ä¢ MCP Server: TypeScript typecheck"
  if [ -f "mcp-server/node_modules/typescript/bin/tsc" ]; then
    (cd mcp-server && node node_modules/typescript/bin/tsc --noEmit)
  else
    # Fallback to normal build if local tsc not found
    (cd mcp-server && npm run -s build)
  fi
fi

# 3) Python syntax check (fast, no dependencies)
echo "‚Ä¢ Python: syntax check (compileall)"
python -m compileall -q apps/backend backend scripts database crawler || {
  echo "‚ùå Python syntax errors detected";
  exit 1;
}

# 4) Extra local checks (if you maintain scripts/pre-commit.sh)
if [ -f "scripts/pre-commit.sh" ]; then
  echo "‚Ä¢ Running extra repo checks (scripts/pre-commit.sh)"
  bash scripts/pre-commit.sh || {
    echo "‚ùå scripts/pre-commit.sh failed";
    exit 1;
  }
fi

echo "‚úÖ All pre-commit checks passed"
