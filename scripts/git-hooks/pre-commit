#!/usr/bin/env bash
set -euo pipefail

echo "üîé Pre-commit checks: lint + typecheck"

PROJECT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$PROJECT_ROOT"

# 1) Frontend ESLint (reuses existing script logic)
if [ -d "apps/web" ]; then
  echo "‚Ä¢ Frontend: ESLint"
  pnpm --filter @web-sydney/web lint

  # Conditionally run Stylelint if available to enforce Design Token guardrails
  if [ -x "apps/web/node_modules/.bin/stylelint" ]; then
    echo "‚Ä¢ Frontend: Stylelint"
    pnpm --filter @web-sydney/web lint:style
  else
    echo "‚Ä¢ Frontend: Stylelint skipped (binary not found)"
  fi
fi

# 2) TypeScript typecheck for MCP server (no emit)
MCP_DIR="apps/mcp-server"
PKG_MGR="pnpm"
if ! command -v pnpm >/dev/null 2>&1; then
  PKG_MGR="npm"
fi

if [ -d "$MCP_DIR" ]; then
  echo "‚Ä¢ MCP Server: TypeScript typecheck"
  if [ -f "$MCP_DIR/node_modules/typescript/bin/tsc" ]; then
    (cd "$MCP_DIR" && node node_modules/typescript/bin/tsc --noEmit)
  else
    # Fallback to normal build if local tsc not found
    (cd "$MCP_DIR" && "$PKG_MGR" run -s build)
  fi
fi

# 3) Python syntax check (fast, no dependencies)
echo "‚Ä¢ Python: syntax check (compileall)"
python -m compileall -q backend scripts database crawler || {
  echo "‚ùå Python syntax errors detected";
  exit 1;
}

# 4) Extra local checks (if you maintain scripts/pre-commit.sh)
if [ -f "scripts/pre-commit.sh" ]; then
  echo "‚Ä¢ Running extra repo checks (scripts/pre-commit.sh)"
  bash scripts/pre-commit.sh || {
    echo "‚ùå scripts/pre-commit.sh failed";
    exit 1;
  }
fi

echo "‚úÖ All pre-commit checks passed"
